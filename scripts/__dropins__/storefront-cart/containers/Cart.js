import{useState as g,useEffect as R,useCallback as Le}from"@dropins/tools/preact-compat.js";import{events as ie}from"@dropins/tools/event-bus.js";import{Divider as Ne,PriceSummary as De,Price as c,Picker as ve,Input as Ie,Button as Se,CartList as Ee,CartItem as Ce,Icon as Pe,Image as be}from"@dropins/tools/components.js";import{E as we,S as Ge}from"../chunks/MiniCart.js";import{classes as B,VComponent as ae}from"@dropins/tools/lib.js";import{jsx as r,jsxs as Y,Fragment as re}from"@dropins/tools/preact-jsx-runtime.js";import{l as _e,s as fe,k as ke}from"../chunks/resetCart.js";import{b as Ue,u as Xe}from"../chunks/updateProductsFromCart.js";import{c as Fe,a as ze,b as Ae,g as Qe}from"../chunks/getEstimatedTotals.js";import{useText as Be}from"@dropins/tools/i18n.js";import"@dropins/tools/fetch-graphql.js";const Re=({className:F,children:h,emptyCart:_,heading:f,products:v,priceSummary:y,...t})=>r("div",{...t,className:B(["cart-cart",F]),children:Y("div",{className:B(["cart-cart__wrapper"]),children:[f&&Y("div",{className:B(["cart-cart__heading",["cart-cart__heading--full-width",!v||!y]]),children:[r(ae,{node:f,className:"cart-cart__heading-text"}),r(Ne,{variant:"primary",className:B(["cart-cart__heading-divider"])})]}),r("div",{className:B(["cart-cart__content",["cart-cart__content--empty",!v],["cart-cart__content--full-width",!y]]),children:v||r(ae,{node:_,className:"cart-cart__empty-cart"})}),v&&y&&r(ae,{node:y,className:B(["cart-cart__price-summary"])})]})}),Ze=()=>{const[F,h]=g(!1),[_,f]=g();return{handleEstimateTotals:(y,t)=>{h(!0);const{shippingCountry:L,shippingState:Z="",shippingZip:N=""}=y,O={countryCode:L,postcode:N,region:{region:Z},shipping_method:{carrier_code:(t==null?void 0:t.carrier_code)||"",method_code:(t==null?void 0:t.method_code)||""}};Fe(O).then(l=>{var G,b,k,d,z,D,U,I,T,E,A,C,i,x,u,p,o,a,n,M;l&&f({estimatedTaxTotal:{amount:(G=l.totalTax)==null?void 0:G.value,currency:(b=l.totalTax)==null?void 0:b.currency},estimatedSubTotal:{excludingTax:{amount:(d=(k=l.subtotal)==null?void 0:k.excludingTax)==null?void 0:d.value,currency:(D=(z=l.subtotal)==null?void 0:z.excludingTax)==null?void 0:D.currency},includingTax:{amount:(I=(U=l.subtotal)==null?void 0:U.includingTax)==null?void 0:I.value,currency:(E=(T=l.subtotal)==null?void 0:T.includingTax)==null?void 0:E.currency},includingDiscountOnly:{amount:(C=(A=l.subtotal)==null?void 0:A.includingDiscountOnly)==null?void 0:C.value,currency:(x=(i=l.subtotal)==null?void 0:i.includingDiscountOnly)==null?void 0:x.currency}},estimatedGrandTotalPrice:{includingTax:{amount:(u=l.total)==null?void 0:u.includingTax.value,currency:(p=l.total)==null?void 0:p.includingTax.currency},excludingTax:{amount:(o=l.total)==null?void 0:o.excludingTax.value,currency:(a=l.total)==null?void 0:a.excludingTax.currency}},estimatedAppliedTaxes:{taxes:(n=l.appliedTaxes)==null?void 0:n.map(s=>{var P,w;return{label:s.label,amount:{value:(P=s.amount)==null?void 0:P.value,currency:(w=s.amount)==null?void 0:w.currency}}})},estimatedItems:{items:(M=l.items)==null?void 0:M.map(s=>{var P,w,$,j,V,q,W,H,J,K;return{uid:s.uid,price:{amount:(P=s.price)==null?void 0:P.value,currency:(w=s.price)==null?void 0:w.currency},taxedPrice:{amount:($=s.taxedPrice)==null?void 0:$.value,currency:(j=s.taxedPrice)==null?void 0:j.currency},rowTotal:{amount:(V=s.rowTotal)==null?void 0:V.value,currency:(q=s.rowTotal)==null?void 0:q.currency},rowTotalIncludingTax:{amount:(W=s.rowTotalIncludingTax)==null?void 0:W.value,currency:(H=s.rowTotalIncludingTax)==null?void 0:H.currency},regularPrice:{amount:(J=s.regularPrice)==null?void 0:J.value,currency:(K=s.regularPrice)==null?void 0:K.currency}}})}})}).finally(()=>{h(!1)})},estimatedTotals:_,loading:F}},Oe=()=>{const[F,h]=g(!1),[_,f]=g([]),[v,y]=g("US"),[t,L]=g(""),[Z,N]=g(""),[O,l]=g([]),[G,b]=g(!1),[k,d]=g(),[z,D]=g(),[U,I]=g(""),[T,E]=g(!1),A=()=>{y("US"),L(""),N(""),d(null),D(null),I(""),E(!1)},C=async x=>{const{shippingCountry:u,shippingState:p="",shippingZip:o=""}=x,a={countryCode:u,postcode:o,region:{region:p}};return h(!0),Qe(a).then(n=>(n&&(d({amount:n.amount.value,currency:n.amount.currency,priceIncludingtax:{amount:n.price_incl_tax.value,currency:n.price_incl_tax.currency},priceExcludingtax:{amount:n.price_excl_tax.value,currency:n.price_excl_tax.currency}}),D({carrier_code:n.carrier_code,method_code:n.method_code}),y(u),L(p),N(o),I(p||o||u),E(!0)),y(u),L(p),N(o),I(p||o||u),n)).finally(()=>{h(!1)})},i=x=>{x.preventDefault(),L(""),N("");const u=x.target.value;y(u)};return R(()=>{ze().then(x=>{let u="US";const p=x.map(o=>(o.isDefaultCountry&&(u=o.id),{text:o.label,value:o.id}));f(p),y(u)})},[]),R(()=>{b(!0),Ae(v).then(x=>{const u=x.map(p=>({text:p.name,value:p.code}));l(u)}).finally(()=>{b(!1)})},[v,b]),{loading:F,regionsLoading:G,estimatedDestinationText:U,countries:_,selectedCountry:v,selectedRegion:t,selectedZip:Z,regions:O,estimatedShippingPrice:k,estimatedShippingMethod:z,shippingEstimated:T,handleEstimateShipping:C,handleCountrySelected:i,resetValues:A,setPriceSummaryLoading:h}},$e=({children:F,initialData:h=null,routeProduct:_,routeEmptyCartCTA:f,routeCheckout:v,...y})=>{var s,P,w,$,j,V,q,W,H,J,K,ce,le,ue,oe;const[t,L]=g(h),[Z,N]=g(new Set),{loading:O,countries:l,regions:G,selectedCountry:b,estimatedDestinationText:k,estimatedShippingPrice:d,handleCountrySelected:z,handleEstimateShipping:D,regionsLoading:U,selectedRegion:I,selectedZip:T,shippingEstimated:E,resetValues:A}=Oe(),{handleEstimateTotals:C,estimatedTotals:i,loading:x}=Ze(),u=(e,m)=>{N(S=>(m?S.add(e):S.delete(e),new Set(S)))},p=(e,m)=>{u(e,!0),Xe([{uid:e,quantity:m}]).catch(S=>{console.warn(S)}).finally(()=>{u(e,!1),k&&o({shippingCountry:b,shippingState:I,shippingZip:T})})},o=Le(e=>{D(e).then(m=>{if(m){const{carrier_code:S,method_code:X}=m;C(e,{carrier_code:S,method_code:X})}else C(e)}).then(()=>{_e(e)})},[D,C]),a=Be({applyButton:"Cart.PriceSummary.estimatedShippingForm.apply.label",checkout:"Cart.PriceSummary.checkout",countryField:"Cart.PriceSummary.estimatedShippingForm.country.placeholder",discountedPrice:"Cart.CartItem.discountedPrice",download:"Cart.CartItem.download",freeShipping:"Cart.PriceSummary.freeShipping",heading:"Cart.Cart.heading",message:"Cart.CartItem.message",orderSummary:"Cart.PriceSummary.orderSummary",regularPrice:"Cart.CartItem.regularPrice",recipient:"Cart.CartItem.recipient",sender:"Cart.CartItem.sender",stateField:"Cart.PriceSummary.estimatedShippingForm.state.placeholder",taxToBeDetermined:"Cart.PriceSummary.taxToBeDetermined",zipField:"Cart.PriceSummary.estimatedShippingForm.zip.placeholder",file:"Cart.CartItem.file",files:"Cart.CartItem.files",lowInventory:"Cart.CartItem.lowInventory",insufficientQuantity:"Cart.CartItem.insufficientQuantity",insufficientQuantityGeneral:"Cart.CartItem.insufficientQuantityGeneral"});R(()=>{const e=ie.on("cart/data",m=>{var X,Q;L(m);const S=(Q=(X=m==null?void 0:m.addresses)==null?void 0:X.shipping)==null?void 0:Q[0];if(S){const{countryCode:ee,regionCode:te,zipCode:ne}=S;o({shippingCountry:ee,shippingState:te,shippingZip:ne})}},{eager:!0});return()=>{e==null||e.off()}},[]),R(()=>{const e=ie.on("cart/merged",()=>{E&&o({shippingCountry:b,shippingState:I,shippingZip:T})});return()=>{e==null||e.off()}},[E,b,I,T]),R(()=>{const e=ie.on("cart/reset",()=>{A(),_e(null)});return()=>{e==null||e.off()}},[]),R(()=>{h&&Object.keys(h).length>0&&Ue(h,fe.locale??"en-US")},[h]);const n=(s=fe.config)==null?void 0:s.shoppingCartDisplaySetting,M=(t==null?void 0:t.totalQuantity)??0?r(De,{"data-testid":"price-summary",loading:O||x,heading:a.orderSummary,total:{price:i!=null&&i.estimatedGrandTotalPrice?r(c,{...i==null?void 0:i.estimatedGrandTotalPrice.includingTax}):r(c,{amount:t==null?void 0:t.total.includingTax.value,currency:t==null?void 0:t.total.includingTax.currency}),estimated:!0,priceWithoutTax:n!=null&&n.grandTotal?i!=null&&i.estimatedAppliedTaxes?r(c,{...i==null?void 0:i.estimatedGrandTotalPrice.excludingTax}):r(c,{amount:t==null?void 0:t.total.excludingTax.value,currency:t==null?void 0:t.total.excludingTax.currency}):void 0},subTotal:{taxIncluded:(n==null?void 0:n.subtotal)==="INCLUDING_TAX"&&!(n!=null&&n.zeroTax),taxExcluded:(n==null?void 0:n.subtotal)==="INCLUDING_EXCLUDING_TAX",zeroTaxSubtotal:n==null?void 0:n.zeroTax,priceExcludingTax:(P=i==null?void 0:i.estimatedSubTotal)!=null&&P.excludingTax?r(c,{"data-testid":"subtotal",...(w=i==null?void 0:i.estimatedSubTotal)==null?void 0:w.excludingTax}):r(c,{"data-testid":"subtotal",amount:($=t==null?void 0:t.subtotal.excludingTax)==null?void 0:$.value,currency:(j=t==null?void 0:t.subtotal.excludingTax)==null?void 0:j.currency}),price:!(n!=null&&n.zeroTax)&&(n==null?void 0:n.subtotal)==="INCLUDING_TAX"||!(n!=null&&n.zeroTax)&&(n==null?void 0:n.subtotal)==="INCLUDING_EXCLUDING_TAX"?(V=i==null?void 0:i.estimatedSubTotal)!=null&&V.includingTax?r(c,{"data-testid":"subtotal",...(q=i==null?void 0:i.estimatedSubTotal)==null?void 0:q.includingTax}):r(c,{"data-testid":"subtotal",amount:(W=t==null?void 0:t.subtotal.includingTax)==null?void 0:W.value,currency:(H=t==null?void 0:t.subtotal.includingTax)==null?void 0:H.currency}):r(c,{"data-testid":"subtotal",amount:(J=t==null?void 0:t.subtotal.excludingTax)==null?void 0:J.value,currency:(K=t==null?void 0:t.subtotal.excludingTax)==null?void 0:K.currency})},shipping:t!=null&&t.isVirtual?void 0:{taxIncluded:(n==null?void 0:n.shipping)==="INCLUDING_TAX",taxExcluded:(n==null?void 0:n.shipping)==="INCLUDING_EXCLUDING_TAX",price:(d==null?void 0:d.amount)==0?r("span",{"data-testId":"free-shipping",children:a.freeShipping}):(n==null?void 0:n.shipping)==="INCLUDING_TAX"&&d?r(c,{"data-testid":"shipping",...d.priceIncludingtax}):d?r(c,{...d}):r("span",{children:a.taxToBeDetermined}),estimated:!0,priceExcludingTax:d!=null&&d.priceExcludingtax?r(c,{"data-testid":"shipping-excluding-tax",...d.priceExcludingtax}):r("span",{children:a.taxToBeDetermined}),countryField:r(ve,{name:"shippingCountry",placeholder:a.countryField,value:b,variant:"primary",options:l,handleSelect:z,"data-testid":"estimate-shipping-country-selector"}),stateField:G.length>0?r(ve,{name:"shippingState",placeholder:a.stateField,variant:"primary",options:G,value:I,"data-testid":"estimate-shipping-state-selector",disabled:U}):r(Ie,{"aria-label":a.stateField,name:"shippingState",placeholder:a.stateField,variant:"primary",value:I,disabled:U,"data-testid":"estimate-shipping-state-input",maxLength:50}),zipField:r(Ie,{"aria-label":a.zipField,name:"shippingZip",placeholder:a.zipField,variant:"primary","data-testid":"estimate-shipping-zip-input",value:T,maxLength:12}),estimateButton:r(Se,{variant:"secondary","data-testid":"estimate-shipping-apply-button","aria-label":a.applyButton,children:a.applyButton}),destinationText:k||a.taxToBeDetermined,onEstimate:o},taxTotal:t!=null&&t.isVirtual?{price:r("span",{"data-testid":"tax-total",children:a.taxToBeDetermined})}:{price:i!=null&&i.estimatedTaxTotal?r(c,{"data-testid":"tax-total",...i==null?void 0:i.estimatedTaxTotal}):t!=null&&t.totalTax?r(c,{"data-testid":"tax-total",amount:(ce=t==null?void 0:t.totalTax)==null?void 0:ce.value,currency:(le=t==null?void 0:t.totalTax)==null?void 0:le.currency}):r("span",{"data-testid":"tax-total",children:a.taxToBeDetermined}),estimated:!0},taxesApplied:t!=null&&t.isVirtual?void 0:n!=null&&n.fullSummary&&(i!=null&&i.estimatedAppliedTaxes)?(oe=(ue=i==null?void 0:i.estimatedAppliedTaxes)==null?void 0:ue.taxes)==null?void 0:oe.map(e=>({label:e.label,price:r(c,{"data-testid":"applied-taxes",amount:e.amount.value,currency:e.amount.currency})})):n!=null&&n.fullSummary?t==null?void 0:t.appliedTaxes.map(e=>({label:e.label,price:r(c,{"data-testid":"applied-taxes",amount:e.amount.value,currency:e.amount.currency})})):void 0,primaryAction:v?r(Se,{"data-testid":"checkout-button",variant:"primary",disabled:t==null?void 0:t.items.some(e=>e.insufficientQuantity),"aria-disabled":t==null?void 0:t.items.some(e=>e.insufficientQuantity),tabIndex:t!=null&&t.items.some(e=>e.insufficientQuantity)?-1:0,href:t!=null&&t.items.some(e=>e.insufficientQuantity)?void 0:v({cartId:t.id}),children:a.checkout}):void 0,discounts:t==null?void 0:t.appliedDiscounts.map(e=>({label:e.label,price:r(c,{"data-testid":"summary-discount-total",amount:-e.amount.value,currency:e.amount.currency,sale:!0})}))}):void 0;return r(Re,{...y,heading:r("div",{children:a.heading}),emptyCart:r(we,{ctaLinkURL:f==null?void 0:f()}),priceSummary:M,products:(t==null?void 0:t.totalQuantity)??0?r(Ee,{children:t==null?void 0:t.items.map((e,m)=>{var Q,ee,te,ne,se,de,pe,ge,ye,me,he,xe;const S=Z.has(e.uid),X={...e.bundleOptions??{},...e.selectedOptions??{},...e.customizableOptions,...e.recipient?{[a.recipient]:e.recipient}:{},...e.recipientEmail&&e.recipient?{[a.recipient]:`${e.recipient} (${e.recipientEmail})`}:{},...e.sender?{[a.sender]:e.sender}:{},...e.senderEmail&&e.sender?{[a.sender]:`${e.sender} (${e.senderEmail})`}:{},...e.message?{[a.message]:e.message}:{},...e.links&&e.links.count?e.links.count>1?{[a.files.replace("{count}",e.links.count.toString())]:e.links.result}:{[a.file.replace("{count}",e.links.count.toString())]:e.links.result}:{}};return r(Ce,{ariaLabel:e.name,updating:S,"data-testid":"cart-item",taxIncluded:(n==null?void 0:n.price)==="INCLUDING_TAX",taxExcluded:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX",warning:e.insufficientQuantity||e.lowInventory?Y("span",{children:[r(Pe,{source:Ge,size:"16"}),e.insufficientQuantity&&e.stockLevel&&(e.stockLevel==="noNumber"?a.insufficientQuantityGeneral:a.insufficientQuantity.replace("{inventory}",(Q=e.stockLevel)==null?void 0:Q.toString()).replace("{count}",e.quantity.toString()))||e.lowInventory&&e.onlyXLeftInStock&&a.lowInventory.replace("{count}",(ee=e.onlyXLeftInStock)==null?void 0:ee.toString())]}):void 0,image:_?r("a",{href:_(e),children:r(be,{loading:m<4?"eager":"lazy",src:e.image.src,alt:e.image.alt,width:"300",height:"300",params:{width:300}})}):r(be,{loading:m<4?"eager":"lazy",src:e.image.src,alt:e.image.alt,width:"300",height:"300",params:{width:300}}),title:r("span",{children:_?r("a",{href:_(e),children:e.name}):r(re,{children:e.name})}),sku:r("span",{children:e.sku}),configurations:Object.keys(X).length>0?X:void 0,quantity:e.quantity,price:(n==null?void 0:n.price)==="INCLUDING_TAX"?r(c,{amount:e.discounted?(te=e.regularPrice)==null?void 0:te.value:(ne=e.taxedPrice)==null?void 0:ne.value,currency:e.discounted?(se=e.regularPrice)==null?void 0:se.currency:(de=e.taxedPrice)==null?void 0:de.currency,style:{font:"inherit"},"data-testid":"including-tax-item-price"}):r(c,{amount:(pe=e.regularPrice)==null?void 0:pe.value,currency:(ge=e.regularPrice)==null?void 0:ge.currency,style:{font:"inherit"},"data-testid":"regular-item-price"}),total:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX"||(n==null?void 0:n.price)==="INCLUDING_TAX"?r(re,{children:e.discounted?Y(re,{children:[r(c,{amount:e.total.value,currency:e.total.currency,variant:e.discounted?"strikethrough":"default","data-testid":"including-tax-row-total","aria-label":a.regularPrice}),r(c,{amount:(ye=e.rowTotalIncludingTax)==null?void 0:ye.value,currency:(me=e.rowTotalIncludingTax)==null?void 0:me.currency,sale:e.discounted,"data-testid":"discount-total","aria-label":a.discountedPrice})]}):r(c,{amount:e.rowTotalIncludingTax.value,currency:e.rowTotalIncludingTax.currency,"data-testid":"including-tax-row-total","aria-label":a.regularPrice})}):Y(re,{children:[r(c,{amount:e.total.value,currency:e.total.currency,variant:e.discounted?"strikethrough":"default","data-testid":"regular-total","aria-label":a.regularPrice}),e.discounted&&r(c,{amount:(he=e.discountedTotal)==null?void 0:he.value,currency:(xe=e.discountedTotal)==null?void 0:xe.currency,sale:e.discounted,"data-testid":"discount-total","aria-label":a.discountedPrice})]}),totalExcludingTax:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX"?r(c,{amount:e.rowTotal.value,currency:e.rowTotal.currency,"data-testid":"excluding-tax-total","aria-label":a.regularPrice}):void 0,onQuantity:Te=>{p(e.uid,Te)},onRemove:()=>{p(e.uid,0)}},e.uid)})}):void 0})};$e.getInitialData=async function(){return ke()};export{$e as Cart,$e as default};
